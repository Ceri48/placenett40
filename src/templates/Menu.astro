---
import {strapiGet} from "../lib/strapi";
import type {Menu} from "../models/Menu";

const {slug} = Astro.props;

const menuRes = await strapiGet<{ data: Menu[] }>(
    "/api/menus",
    {
        query: {
            "filters[slug][$eq]": slug,
            // populate bien structuré (objet), avec relations imbriquées
            populate: {
                Liens: {
                    populate: {article: {fields: ["slug", "titre"]}},
                    sort: ["Ordre:asc"],
                },
                LiensGroupee: {
                    populate: {
                        Liens: {
                            populate: {article: {fields: ["slug", "titre"]}},
                            sort: ["Ordre:asc"],
                        },
                    },
                    sort: ["Ordre:asc"],
                },
            },
            "pagination[limit]": 1,
        },
    }
);

const menu = menuRes?.data?.[0] || null;
---

<ul>
    {menu.Liens?.map(lien => (
            <li>
                <a href={`/articles/${lien.article?.slug}/`}>
                    {lien.Texte}
                </a>
            </li>
    ))}

    {menu.LiensGroupee?.map(group => (
            <li>

                <button class="btn-collapse-menu" type="button">
                    <i class="lni lni-chevron-down"></i>
                    {group.Texte}
                </button>


                <ul>
                    {group.Liens?.map(lien => (
                            <li>
                                <a href={`/articles/${lien.article?.slug}/`}>
                                    {lien.Texte}
                                </a>
                            </li>
                    ))}
                </ul>
            </li>
    ))}

</ul>

<script is:inline>
    const btns = document.querySelectorAll('.btn-collapse-menu');
    btns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            const icon = btn.querySelector('.lni');
            icon.classList.toggle('lni-chevron-down');
            icon.classList.toggle('lni-chevron-up');
            btn.closest("li")
                .querySelector("ul")
                .classList.toggle('collapsed');
        })
    })

</script>
